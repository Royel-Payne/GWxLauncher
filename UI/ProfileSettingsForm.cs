using GWxLauncher.Config;
using GWxLauncher.Domain;
using GWxLauncher.Properties;
using GWxLauncher.Services;
using GWxLauncher.UI.TabControls;

namespace GWxLauncher.UI
{
    public partial class ProfileSettingsForm : Form
    {
        // -----------------------------
        // Fields / State
        // -----------------------------

        private readonly GameProfile _profile;
        private readonly LauncherConfig _cfg;
        
        // Used to prevent event handlers from triggering during LoadFromProfile()
        #pragma warning disable CS0414 // Field is assigned but never read - used for control flow
        private bool _loadingProfile;
        #pragma warning restore CS0414

        // Tab infrastructure (created at runtime, not in Designer)
        private Panel? _pnlButtonBar;
        private Panel? _pnlSidebar;
        private Panel? _pnlSplitter;
        private Panel? _pnlContentViewport;
        private ListBox? _lstTabs;

        // Tab content UserControls
        private GeneralTabContent? _generalTab;
        private LoginTabContent? _loginTab;
        private ModsTabContent? _modsTab;
        private WindowTabContent? _windowTab;

        // -----------------------------
        // Ctor / Form lifecycle
        // -----------------------------

        public ProfileSettingsForm(GameProfile profile)
        {
            _profile = profile ?? throw new ArgumentNullException(nameof(profile));

            // Step 1: Let the Designer create all original controls
            InitializeComponent();

            // Step 2: Create tab infrastructure (NEW)
            CreateTabInfrastructure();

            // Step 3: Create UserControl instances
            CreateTabControls();

            // Step 4: Reparent existing controls into UserControls
            ReparentControlsToTabs();

            // Step 5: Wire up tab switching
            InitTabSidebar();

            // Step 6: Apply theme
            ThemeService.ApplyToForm(this);

            // Step 7: Existing initialization logic

            // Step 8: Form icon per game
            Icon = _profile.GameType switch
            {
                GameType.GuildWars1 => Resources.Gw1Icon,
                GameType.GuildWars2 => Resources.Gw2Icon,
                _ => Icon
            };

            _cfg = LauncherConfig.Load();


            Shown += ProfileSettingsForm_Shown;


            Text = $"Profile Settings – {profile.Name}";

            AcceptButton = btnOk;
            CancelButton = btnCancel;

            // Step 9: Load profile data
            LoadFromProfile();

            // Step 10: Select default tab
            if (_lstTabs != null)
                _lstTabs.SelectedIndex = 0;

            // Wire up form buttons based on new structure
            btnOk.Click += btnOk_Click;
            btnCancel.Click += btnCancel_Click;
        }

        // -----------------------------
        // Tab Infrastructure Setup
        // -----------------------------

        private void CreateTabInfrastructure()
        {
            // Button bar (bottom) - add FIRST for correct docking order
            _pnlButtonBar = new Panel
            {
                Dock = DockStyle.Bottom,
                Height = 55,
                BackColor = ThemeService.Palette.WindowBack
            };
            this.Controls.Add(_pnlButtonBar);

            // Content viewport (add BEFORE sidebar so sidebar appears on top)
            _pnlContentViewport = new Panel
            {
                Dock = DockStyle.Fill,
                AutoScroll = true,
                BackColor = ThemeService.Palette.WindowBack,
                Padding = new Padding(0)
            };
            this.Controls.Add(_pnlContentViewport);

            // Fix mouse wheel focus trap
            _pnlContentViewport.MouseEnter += (s, e) => _pnlContentViewport?.Focus();

            // Splitter (visual separator) - add AFTER viewport
            _pnlSplitter = new Panel
            {
                Dock = DockStyle.Left,
                Width = 1,
                BackColor = ThemeService.Palette.Separator
            };
            this.Controls.Add(_pnlSplitter);

            // Sidebar (left) - add LAST so it appears on top
            _pnlSidebar = new Panel
            {
                Dock = DockStyle.Left,
                Width = 150,
                BackColor = ThemeService.Palette.SurfaceBack
            };
            this.Controls.Add(_pnlSidebar);

            // Tab list
            _lstTabs = new ListBox
            {
                Dock = DockStyle.Fill,
                DrawMode = DrawMode.OwnerDrawFixed,
                ItemHeight = 48,
                BorderStyle = BorderStyle.None,
                SelectionMode = SelectionMode.One,
                IntegralHeight = false,
                BackColor = ThemeService.Palette.SurfaceBack,
                ForeColor = ThemeService.Palette.WindowFore
            };
            _lstTabs.Items.AddRange(new object[] { "General", "Login", "Mods/Plugins", "Windowed Mode" });
            _pnlSidebar.Controls.Add(_lstTabs);
        }

        private void CreateTabControls()
        {
            if (_pnlContentViewport == null) return;

            // General tab
            _generalTab = new GeneralTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false,
                GameType = _profile.GameType
            };
            _generalTab.MouseEnter += (s, e) => _generalTab?.Focus();
            _pnlContentViewport.Controls.Add(_generalTab);

            // Login tab
            _loginTab = new LoginTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false
            };
            _loginTab.MouseEnter += (s, e) => _loginTab?.Focus();
            _pnlContentViewport.Controls.Add(_loginTab);

            // Mods tab
            _modsTab = new ModsTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false
            };
            _modsTab.MouseEnter += (s, e) => _modsTab?.Focus();
            _pnlContentViewport.Controls.Add(_modsTab);

            // Window tab
            _windowTab = new WindowTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false
            };
            _windowTab.MouseEnter += (s, e) => _windowTab?.Focus();
            _pnlContentViewport.Controls.Add(_windowTab);
        }

        private void ReparentControlsToTabs()
        {
            if (_pnlButtonBar == null)
                return;

            // Legacy controls are GONE from Designer, so nothing to reparent for General, Login, or Mods.
            // Just move button bar buttons.

            this.Controls.Remove(btnOk);
            this.Controls.Remove(btnCancel);

            _pnlButtonBar.Controls.Add(btnOk);
            _pnlButtonBar.Controls.Add(btnCancel);

            btnOk.Anchor = AnchorStyles.Bottom | AnchorStyles.Right;
            btnCancel.Anchor = AnchorStyles.Bottom | AnchorStyles.Right;
            btnOk.Location = new Point(_pnlButtonBar.Width - 170, 15);
            btnCancel.Location = new Point(_pnlButtonBar.Width - 85, 15);
        }

        private void InitTabSidebar()
        {
            if (_lstTabs == null) return;

            _lstTabs.SelectedIndexChanged += lstTabs_SelectedIndexChanged;
            _lstTabs.DrawItem += lstTabs_DrawItem;
        }

        private void lstTabs_SelectedIndexChanged(object? sender, EventArgs e)
        {
            if (_lstTabs == null || _lstTabs.SelectedIndex < 0) return;
            if (_generalTab == null || _loginTab == null || _modsTab == null || _windowTab == null) return;

            // Hide all tabs
            _generalTab.Visible = false;
            _loginTab.Visible = false;
            _modsTab.Visible = false;
            _windowTab.Visible = false;

            // Show selected tab
            switch (_lstTabs.SelectedIndex)
            {
                case 0: // General
                    _generalTab.Visible = true;
                    _generalTab.Focus();
                    _generalTab.BindProfile(_profile); // Re-bind on switch
                    break;

                case 1: // Login
                    _loginTab.Visible = true;
                    _loginTab.Focus();
                    _loginTab.BindProfile(_profile, _cfg.Gw2IsolationEnabled); // Pass global isolation setting
                    break;

                case 2: // Mods/Plugins
                    _modsTab.Visible = true;
                    _modsTab.Focus();
                    _modsTab.UpdateForGameType(_profile.GameType);
                    break;

                case 3: // Windowed Mode
                    _windowTab.Visible = true;
                    _windowTab.Focus();
                    break;
            }

            // Reset scroll position
            if (_pnlContentViewport != null)
                _pnlContentViewport.AutoScrollPosition = new Point(0, 0);
        }

        private void lstTabs_DrawItem(object? sender, DrawItemEventArgs e)
        {
            if (_lstTabs == null || e.Index < 0) return;

            bool isSelected = (e.State & DrawItemState.Selected) == DrawItemState.Selected;

            // Background
            Color backColor = isSelected
                ? ThemeService.Palette.ButtonBack
                : ThemeService.Palette.SurfaceBack;

            using (var brush = new SolidBrush(backColor))
                e.Graphics.FillRectangle(brush, e.Bounds);

            // Left accent bar for selected item
            if (isSelected)
            {
                using (var accentBrush = new SolidBrush(ThemeService.CardPalette.Accent))
                {
                    var accentRect = new Rectangle(e.Bounds.Left, e.Bounds.Top, 4, e.Bounds.Height);
                    e.Graphics.FillRectangle(accentBrush, accentRect);
                }
            }

            // Text
            string text = _lstTabs.Items[e.Index].ToString() ?? "";
            Color textColor = isSelected
                ? ThemeService.Palette.WindowFore
                : ThemeService.Palette.SubtleFore;

            TextRenderer.DrawText(
                e.Graphics,
                text,
                _lstTabs.Font,
                new Rectangle(e.Bounds.Left + 16, e.Bounds.Top, e.Bounds.Width - 16, e.Bounds.Height),
                textColor,
                TextFormatFlags.VerticalCenter | TextFormatFlags.Left);
        }

        private void ProfileSettingsForm_Shown(object? sender, EventArgs e)
        {
            // If we restored from saved placement, don't override it.
            // if (_restoredFromSavedPlacement) return;

            // If we have an owner (MainForm shows this dialog with ShowDialog(this)), anchor near it.
            if (Owner != null)
            {
                var ownerBounds = Owner.Bounds;

                // Prefer to the right of the owner; if no space, place to the left.
                var wa = Screen.FromControl(Owner).WorkingArea;

                int gap = 12;
                int xRight = ownerBounds.Right + gap;
                int xLeft = ownerBounds.Left - gap - Width;

                int x =
                    (xRight + Width <= wa.Right) ? xRight :
                    (xLeft >= wa.Left) ? xLeft :
                    Math.Max(wa.Left, Math.Min(xRight, wa.Right - Width));

                int y = Math.Max(wa.Top, Math.Min(ownerBounds.Top, wa.Bottom - Height));

                StartPosition = FormStartPosition.Manual;
                Location = new Point(x, y);
            }
            else
            {
                // No owner: fallback to a reasonable default
                StartPosition = FormStartPosition.CenterScreen;
            }
        }

        private void Unused_ProfileSettingsForm_FormClosing(object? sender, FormClosingEventArgs e)
        {
            if (WindowState == FormWindowState.Normal)
            {
                _cfg.ProfileSettingsX = Left;
                _cfg.ProfileSettingsY = Top;
                //_cfg.ProfileSettingsWidth = Width;
                //_cfg.ProfileSettingsHeight = Height;
                _cfg.Save();
            }
            else
            {
                // If minimized/maximized, save RestoreBounds instead (so we persist something sane)
                var b = RestoreBounds;
                _cfg.ProfileSettingsX = b.Left;
                _cfg.ProfileSettingsY = b.Top;
                //_cfg.ProfileSettingsWidth = b.Width;
                //_cfg.ProfileSettingsHeight = b.Height;
                _cfg.Save();
            }
        }

        private void Unused_TryRestoreSavedPlacement()
        {
            if (_cfg.ProfileSettingsX >= 0 && _cfg.ProfileSettingsY >= 0)
            {
                StartPosition = FormStartPosition.Manual;
                Location = new Point(_cfg.ProfileSettingsX, _cfg.ProfileSettingsY);
                // _restoredFromSavedPlacement = true;
            }

            if (false) // was size check
            {
                // Size = new Size(_cfg.ProfileSettingsWidth, _cfg.ProfileSettingsHeight);
            }
        }

        // -----------------------------
        // Load / Save
        // -----------------------------

        private void LoadFromProfile()
        {
            _loadingProfile = true;

            // Bind independent tabs
            _generalTab?.BindProfile(_profile);
            _loginTab?.BindProfile(_profile, _cfg.Gw2IsolationEnabled); // Pass global isolation setting
            _modsTab?.BindProfile(_profile);
            _windowTab?.BindProfile(_profile);

            _loadingProfile = false;
        }

        private void SaveToProfile()
        {
            // Delegate saving to autonomous tabs
            _generalTab?.SaveProfile(_profile);
            _loginTab?.SaveProfile(_profile);
            _modsTab?.SaveProfile(_profile);
            _windowTab?.SaveProfile(_profile);
        }

        private bool ValidateGw1ModSettings()
        {
            // This logic is now inside ModsTabContent, but validation strategy for user controls is tricky.
            // Ideally UserControl has Validate() method or similar.
            // For now, we will assume validation is done OR we can replicate checks since we can't easily reach into UC state without exposing it.
            // Actually, we can check the profile object AFTER SaveToProfile() is called.

            if (_profile.GameType != GameType.GuildWars1)
                return true;

            if (_profile.Gw1ToolboxEnabled && string.IsNullOrWhiteSpace(_profile.Gw1ToolboxDllPath))
            {
                MessageBox.Show(this, "Toolbox enabled but no DLL path set.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }
            if (_profile.Gw1Py4GwEnabled && string.IsNullOrWhiteSpace(_profile.Gw1Py4GwDllPath))
            {
                MessageBox.Show(this, "Py4GW enabled but no DLL path set.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }
            if (_profile.Gw1GModEnabled && string.IsNullOrWhiteSpace(_profile.Gw1GModDllPath))
            {
                MessageBox.Show(this, "GMod enabled but no DLL path set.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }
            return true;
        }

        // -----------------------------
        // Buttons / DialogResult
        // -----------------------------

        private void btnOk_Click(object? sender, EventArgs e)
        {
            // 1. Save tabs to profile object
            SaveToProfile();

            // 2. Validate using profile state (since UI state is inside UCs)
            if (string.IsNullOrEmpty(_profile.Name))
            {
                MessageBox.Show(
                    this,
                    "Please enter a display name.",
                    "Validation",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning);

                DialogResult = DialogResult.None;
                return;
            }

            if (!ValidateGw1ModSettings())
            {
                DialogResult = DialogResult.None;
                return;
            }

            // If GW1 + gMod enabled, prepare %AppData% copy + modlist.txt now
            if (_profile.GameType == GameType.GuildWars1 && _profile.Gw1GModEnabled)
            {
                try
                {
                    Gw1InjectionService.PreparePerProfileGModFolder(_profile);
                }
                catch (Exception ex)
                {
                    MessageBox.Show(
                        this,
                        $"gMod is enabled but setup failed:\n\n{ex.Message}",
                        "gMod setup failed",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Warning);

                    DialogResult = DialogResult.None;
                    return;
                }
            }

            DialogResult = DialogResult.OK;
            Close();
        }

        private void btnCancel_Click(object? sender, EventArgs e)
        {
            DialogResult = DialogResult.Cancel;
            Close();
        }
    }
}






















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































