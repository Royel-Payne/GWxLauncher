using System.Diagnostics;
using GWxLauncher.Config;
using GWxLauncher.Domain;
using GWxLauncher.Properties;
using GWxLauncher.Services;
using GWxLauncher.UI.Helpers;
using GWxLauncher.UI.TabControls;

namespace GWxLauncher.UI
{
    public partial class ProfileSettingsForm : Form
    {
        // -----------------------------
        // Fields / State
        // -----------------------------

        private readonly GameProfile _profile;
        private readonly LauncherConfig _cfg;
        private bool _loadingProfile;

        private bool _restoredFromSavedPlacement;
        private bool _gw1GmodPluginsInteractive = true;
        private bool _gw2RunAfterInteractive = true;

        // Tab infrastructure (created at runtime, not in Designer)
        private Panel? _pnlButtonBar;
        private Panel? _pnlSidebar;
        private Panel? _pnlSplitter;
        private Panel? _pnlContentViewport;
        private ListBox? _lstTabs;

        // Tab content UserControls
        private GeneralTabContent? _generalTab;
        private LoginTabContent? _loginTab;
        private ModsTabContent? _modsTab;
        private WindowTabContent? _windowTab;

        // -----------------------------
        // Ctor / Form lifecycle
        // -----------------------------

        public ProfileSettingsForm(GameProfile profile)
        {
            _profile = profile ?? throw new ArgumentNullException(nameof(profile));

            // Step 1: Let the Designer create all original controls
            InitializeComponent();

            // Step 2: Create tab infrastructure (NEW)
            CreateTabInfrastructure();

            // Step 3: Create UserControl instances
            CreateTabControls();

            // Step 4: Reparent existing controls into UserControls
            ReparentControlsToTabs();

            // Step 5: Wire up tab switching
            InitTabSidebar();

            // Step 6: Apply theme
            ThemeService.ApplyToForm(this);

            // Step 7: Existing initialization logic
            InitGw2RunAfterContextMenu();
            WireUpExistingEventHandlers();

            // Step 8: Form icon per game
            Icon = _profile.GameType switch
            {
                GameType.GuildWars1 => Resources.Gw1Icon,
                GameType.GuildWars2 => Resources.Gw2Icon,
                _ => Icon
            };

            _cfg = LauncherConfig.Load();

            TryRestoreSavedPlacement();
            Shown += ProfileSettingsForm_Shown;
            FormClosing += ProfileSettingsForm_FormClosing;

            Text = $"Profile Settings – {profile.Name}";

            AcceptButton = btnOk;
            CancelButton = btnCancel;

            // Step 9: Load profile data
            LoadFromProfile();

            // Step 10: Select default tab
            if (_lstTabs != null)
                _lstTabs.SelectedIndex = 0;
        }

        // -----------------------------
        // Tab Infrastructure Setup
        // -----------------------------

        private void CreateTabInfrastructure()
        {
            // Button bar (bottom) - add FIRST for correct docking order
            _pnlButtonBar = new Panel
            {
                Dock = DockStyle.Bottom,
                Height = 55,
                BackColor = ThemeService.Palette.WindowBack
            };
            this.Controls.Add(_pnlButtonBar);

            // Content viewport (add BEFORE sidebar so sidebar appears on top)
            _pnlContentViewport = new Panel
            {
                Dock = DockStyle.Fill,
                AutoScroll = true,
                BackColor = ThemeService.Palette.WindowBack,
                Padding = new Padding(0)
            };
            this.Controls.Add(_pnlContentViewport);

            // Fix mouse wheel focus trap
            _pnlContentViewport.MouseEnter += (s, e) => _pnlContentViewport?.Focus();

            // Splitter (visual separator) - add AFTER viewport
            _pnlSplitter = new Panel
            {
                Dock = DockStyle.Left,
                Width = 1,
                BackColor = ThemeService.Palette.Separator
            };
            this.Controls.Add(_pnlSplitter);

            // Sidebar (left) - add LAST so it appears on top
            _pnlSidebar = new Panel
            {
                Dock = DockStyle.Left,
                Width = 150,
                BackColor = ThemeService.Palette.SurfaceBack
            };
            this.Controls.Add(_pnlSidebar);

            // Tab list
            _lstTabs = new ListBox
            {
                Dock = DockStyle.Fill,
                DrawMode = DrawMode.OwnerDrawFixed,
                ItemHeight = 48,
                BorderStyle = BorderStyle.None,
                SelectionMode = SelectionMode.One,
                IntegralHeight = false,
                BackColor = ThemeService.Palette.SurfaceBack,
                ForeColor = ThemeService.Palette.WindowFore
            };
            _lstTabs.Items.AddRange(new object[] { "General", "Login", "Mods/Plugins", "Windowed Mode" });
            _pnlSidebar.Controls.Add(_lstTabs);
        }

        private void CreateTabControls()
        {
            if (_pnlContentViewport == null) return;

            // General tab
            _generalTab = new GeneralTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false,
                GameType = _profile.GameType
            };
            _generalTab.MouseEnter += (s, e) => _generalTab?.Focus();
            _pnlContentViewport.Controls.Add(_generalTab);

            // Login tab
            _loginTab = new LoginTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false
            };
            _loginTab.MouseEnter += (s, e) => _loginTab?.Focus();
            _pnlContentViewport.Controls.Add(_loginTab);

            // Mods tab
            _modsTab = new ModsTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false
            };
            _modsTab.MouseEnter += (s, e) => _modsTab?.Focus();
            _pnlContentViewport.Controls.Add(_modsTab);

            // Window tab
            _windowTab = new WindowTabContent
            {
                Dock = DockStyle.Fill,
                Visible = false
            };
            _windowTab.MouseEnter += (s, e) => _windowTab?.Focus();
            _pnlContentViewport.Controls.Add(_windowTab);
        }

        private void ReparentControlsToTabs()
        {
            if (_modsTab == null || _pnlButtonBar == null)
                return;

            // ===== GENERAL TAB & LOGIN TAB =====
            // Controls now autonomous in UserControls.

            // ===== MODS TAB ===== (OLD APPROACH KEPT FOR MODS)
            var gw1ModsControls = grpGw1Mods.Controls.Cast<Control>().ToArray();
            var gw2RunAfterControls = grpGw2RunAfter.Controls.Cast<Control>().ToArray();

            foreach (var ctrl in gw1ModsControls)
                grpGw1Mods.Controls.Remove(ctrl);

            foreach (var ctrl in gw2RunAfterControls)
                grpGw2RunAfter.Controls.Remove(ctrl);

            this.Controls.Remove(grpGw1Mods);
            this.Controls.Remove(grpGw2RunAfter);

            // Call the existing ArrangeControls method for Mods
            _modsTab.ArrangeControls(gw1ModsControls, gw2RunAfterControls);

            // ===== BUTTON BAR =====
            this.Controls.Remove(btnOk);
            this.Controls.Remove(btnCancel);

            _pnlButtonBar.Controls.Add(btnOk);
            _pnlButtonBar.Controls.Add(btnCancel);

            btnOk.Anchor = AnchorStyles.Bottom | AnchorStyles.Right;
            btnCancel.Anchor = AnchorStyles.Bottom | AnchorStyles.Right;
            btnOk.Location = new Point(_pnlButtonBar.Width - 170, 15);
            btnCancel.Location = new Point(_pnlButtonBar.Width - 85, 15);
        }

        private void InitTabSidebar()
        {
            if (_lstTabs == null) return;

            _lstTabs.SelectedIndexChanged += lstTabs_SelectedIndexChanged;
            _lstTabs.DrawItem += lstTabs_DrawItem;
        }

        private void lstTabs_SelectedIndexChanged(object? sender, EventArgs e)
        {
            if (_lstTabs == null || _lstTabs.SelectedIndex < 0) return;
            if (_generalTab == null || _loginTab == null || _modsTab == null || _windowTab == null) return;

            // Hide all tabs
            _generalTab.Visible = false;
            _loginTab.Visible = false;
            _modsTab.Visible = false;
            _windowTab.Visible = false;

            // Show selected tab
            switch (_lstTabs.SelectedIndex)
            {
                case 0: // General
                    _generalTab.Visible = true;
                    _generalTab.Focus();
                    _generalTab.BindProfile(_profile); // Re-bind on switch
                    break;

                case 1: // Login
                    _loginTab.Visible = true;
                    _loginTab.Focus();
                    _loginTab.BindProfile(_profile); // Re-bind on switch
                    break;

                case 2: // Mods/Plugins
                    _modsTab.Visible = true;
                    _modsTab.Focus();
                    _modsTab.UpdateForGameType(_profile.GameType);
                    break;

                case 3: // Windowed Mode
                    _windowTab.Visible = true;
                    _windowTab.Focus();
                    break;
            }

            // Reset scroll position
            if (_pnlContentViewport != null)
                _pnlContentViewport.AutoScrollPosition = new Point(0, 0);
        }

        private void lstTabs_DrawItem(object? sender, DrawItemEventArgs e)
        {
            if (_lstTabs == null || e.Index < 0) return;

            bool isSelected = (e.State & DrawItemState.Selected) == DrawItemState.Selected;

            // Background
            Color backColor = isSelected 
                ? ThemeService.Palette.ButtonBack 
                : ThemeService.Palette.SurfaceBack;
            
            using (var brush = new SolidBrush(backColor))
                e.Graphics.FillRectangle(brush, e.Bounds);

            // Left accent bar for selected item
            if (isSelected)
            {
                using (var accentBrush = new SolidBrush(ThemeService.CardPalette.Accent))
                {
                    var accentRect = new Rectangle(e.Bounds.Left, e.Bounds.Top, 4, e.Bounds.Height);
                    e.Graphics.FillRectangle(accentBrush, accentRect);
                }
            }

            // Text
            string text = _lstTabs.Items[e.Index].ToString() ?? "";
            Color textColor = isSelected 
                ? ThemeService.Palette.WindowFore 
                : ThemeService.Palette.SubtleFore;

            TextRenderer.DrawText(
                e.Graphics,
                text,
                _lstTabs.Font,
                new Rectangle(e.Bounds.Left + 16, e.Bounds.Top, e.Bounds.Width - 16, e.Bounds.Height),
                textColor,
                TextFormatFlags.VerticalCenter | TextFormatFlags.Left);
        }

        private void WireUpExistingEventHandlers()
        {
            // ListView theming + selection handlers
            lvGw2RunAfter.BackColor = ThemeService.Palette.InputBack;
            lvGw2RunAfter.ForeColor = ThemeService.Palette.InputFore;
            lvGw2RunAfter.SelectedIndexChanged += (s, e) => UpdateGw2RunAfterButtons();

            lvGw1GModPlugins.BackColor = ThemeService.Palette.InputBack;
            lvGw1GModPlugins.ForeColor = ThemeService.Palette.InputFore;
            lvGw1GModPlugins.SelectedIndexChanged += (s, e) => UpdateGw1GModPluginButtons();

            // When "disabled", prevent selection/checking
            lvGw2RunAfter.ItemSelectionChanged += (s, e) =>
            {
                if (!_gw2RunAfterInteractive && e.IsSelected)
                {
                    if (e.Item != null)
                        e.Item.Selected = false;
                }
            };
            lvGw2RunAfter.ItemCheck += (s, e) =>
            {
                if (!_gw2RunAfterInteractive)
                    e.NewValue = e.CurrentValue;
            };

            // Explicit button handlers
            btnGw1AddPlugin.Click += btnGw1AddPlugin_Click;
            btnGw1RemovePlugin.Click += btnGw1RemovePlugin_Click;
            btnOk.Click += btnOk_Click;
            
            btnBrowseToolboxDll.Click += btnBrowseToolboxDll_Click;
            btnBrowsePy4GwDll.Click += btnBrowsePy4GwDll_Click;
            btnBrowseGModDll.Click += btnBrowseGModDll_Click;
            btnCancel.Click += btnCancel_Click;
        }
        private void lvGw2RunAfter_DrawColumnHeader(object sender, DrawListViewColumnHeaderEventArgs e)
        {
            e.DrawDefault = true;
        }
        private void lvGw2RunAfter_DrawSubItem(object sender, DrawListViewSubItemEventArgs e)
        {
            // Column 0: let WinForms draw checkbox + default visuals
            if (e.ColumnIndex == 0)
            {
                e.DrawDefault = true;
                return;
            }

            // We only customize the Name column (column 1)
            if (e.ColumnIndex != 1)
            {
                e.DrawDefault = true;
                return;
            }

            // --- Paint background (selection-aware) ---
            Color back = lvGw2RunAfter.BackColor;
            Color fore = lvGw2RunAfter.ForeColor;

            if (e.Item != null && e.Item.Selected)
            {
                back = ThemeService.Palette.ButtonBack;
                fore = ThemeService.Palette.ButtonFore;
            }

            using (var bg = new SolidBrush(back))
                e.Graphics.FillRectangle(bg, e.Bounds);

            var p = e.Item?.Tag as RunAfterProgram;

            // --- Compute badge rect (right-aligned) ---
            bool showBadge = (p != null && p.PassMumbleLinkName);
            string badgeText = "M";

            // tighter ListView badge sizing (not the big card metrics)
            const int badgePadX = 10;
            const int badgePadY = 3;
            const int badgeRightPad = 8;

            using var badgeFont = new Font(ThemeService.Typography.BadgeFont.FontFamily, 7.5f, FontStyle.Bold);

            int badgeW = 0;
            int badgeH = 0;

            if (showBadge)
            {
                var sz = e.Graphics.MeasureString(badgeText, badgeFont);
                badgeW = (int)sz.Width + badgePadX;
                badgeH = (int)sz.Height + badgePadY;
            }

            // --- Text rect is the cell minus the badge area ---
            var textRect = e.Bounds;
            if (showBadge)
                textRect = Rectangle.FromLTRB(e.Bounds.Left, e.Bounds.Top, e.Bounds.Right - (badgeW + badgeRightPad), e.Bounds.Bottom);

            // Fix: Check for null before accessing e.SubItem.Text
            string subItemText = e.SubItem?.Text ?? string.Empty;

            TextRenderer.DrawText(
                e.Graphics,
                subItemText,
                lvGw2RunAfter.Font,
                textRect,
                fore,
                TextFormatFlags.Left | TextFormatFlags.VerticalCenter | TextFormatFlags.EndEllipsis);

            // --- Draw badge pill (like MainForm badges) ---
            if (showBadge)
            {
                int x = e.Bounds.Right - badgeRightPad - badgeW;
                int y = e.Bounds.Top + (e.Bounds.Height - badgeH) / 2;
                var rect = new Rectangle(x, y, badgeW, badgeH);

                using var badgeBg = new SolidBrush(ThemeService.CardPalette.BadgeBack);
                using var badgePen = new Pen(ThemeService.CardPalette.BadgeBorder);

                e.Graphics.FillRectangle(badgeBg, rect);
                e.Graphics.DrawRectangle(badgePen, rect);

                TextRenderer.DrawText(
                    e.Graphics,
                    badgeText,
                    badgeFont,
                    rect,
                    ThemeService.CardPalette.BadgeFore,
                    TextFormatFlags.HorizontalCenter | TextFormatFlags.VerticalCenter);
            }
        }
        private void ProfileSettingsForm_Shown(object? sender, EventArgs e)
        {
            // If we restored from saved placement, don't override it.
            if (_restoredFromSavedPlacement)
                return;

            // If we have an owner (MainForm shows this dialog with ShowDialog(this)), anchor near it.
            if (Owner != null)
            {
                var ownerBounds = Owner.Bounds;

                // Prefer to the right of the owner; if no space, place to the left.
                var wa = Screen.FromControl(Owner).WorkingArea;

                int gap = 12;
                int xRight = ownerBounds.Right + gap;
                int xLeft = ownerBounds.Left - gap - Width;

                int x =
                    (xRight + Width <= wa.Right) ? xRight :
                    (xLeft >= wa.Left) ? xLeft :
                    Math.Max(wa.Left, Math.Min(xRight, wa.Right - Width));

                int y = Math.Max(wa.Top, Math.Min(ownerBounds.Top, wa.Bottom - Height));

                StartPosition = FormStartPosition.Manual;
                Location = new Point(x, y);
            }
            else
            {
                // No owner: fallback to a reasonable default
                StartPosition = FormStartPosition.CenterScreen;
            }
        }

        private void ProfileSettingsForm_FormClosing(object? sender, FormClosingEventArgs e)
        {
            if (WindowState == FormWindowState.Normal)
            {
                _cfg.ProfileSettingsX = Left;
                _cfg.ProfileSettingsY = Top;
                _cfg.ProfileSettingsWidth = Width;
                _cfg.ProfileSettingsHeight = Height;
                _cfg.Save();
            }
            else
            {
                // If minimized/maximized, save RestoreBounds instead (so we persist something sane)
                var b = RestoreBounds;
                _cfg.ProfileSettingsX = b.Left;
                _cfg.ProfileSettingsY = b.Top;
                _cfg.ProfileSettingsWidth = b.Width;
                _cfg.ProfileSettingsHeight = b.Height;
                _cfg.Save();
            }
        }

        private void TryRestoreSavedPlacement()
        {
            if (_cfg.ProfileSettingsX >= 0 && _cfg.ProfileSettingsY >= 0)
            {
                StartPosition = FormStartPosition.Manual;
                Location = new Point(_cfg.ProfileSettingsX, _cfg.ProfileSettingsY);
                _restoredFromSavedPlacement = true;
            }

            if (_cfg.ProfileSettingsWidth > 0 && _cfg.ProfileSettingsHeight > 0)
            {
                Size = new Size(_cfg.ProfileSettingsWidth, _cfg.ProfileSettingsHeight);
            }
        }

        // -----------------------------
        // Load / Save
        // -----------------------------

        private void LoadFromProfile()
        {
            _loadingProfile = true;

            // Bind independent tabs
            _generalTab?.BindProfile(_profile);
            _loginTab?.BindProfile(_profile);

            // Legacy loading for Mods tab
            chkGw2RunAfterEnabled.CheckedChanged += (s, e) => UpdateGw2RunAfterUiState();
            
            chkToolbox.CheckedChanged += (s, e) =>
            {
                if (!_loadingProfile && chkToolbox.Checked)
                    EnsureDllSelectedOrRevert(chkToolbox, txtToolboxDll, "GWToolboxdll.dll");
                UpdateGw1ModsUiState();
            };

            chkPy4Gw.CheckedChanged += (s, e) =>
            {
                if (!_loadingProfile && chkPy4Gw.Checked)
                    EnsureDllSelectedOrRevert(chkPy4Gw, txtPy4GwDll, "Py4GW DLL");
                UpdateGw1ModsUiState();
            };

            chkGMod.CheckedChanged += (s, e) =>
            {
                if (!_loadingProfile && chkGMod.Checked)
                    EnsureDllSelectedOrRevert(chkGMod, txtGModDll, "gMod.dll");
                UpdateGw1ModsUiState();
            };

            bool isGw1 = _profile.GameType == GameType.GuildWars1;
            bool isGw2 = _profile.GameType == GameType.GuildWars2;

            if (isGw1)
            {
                txtToolboxDll.Text = _profile.Gw1ToolboxDllPath;
                chkToolbox.Checked = _profile.Gw1ToolboxEnabled;

                txtPy4GwDll.Text = _profile.Gw1Py4GwDllPath;
                chkPy4Gw.Checked = _profile.Gw1Py4GwEnabled;

                txtGModDll.Text = _profile.Gw1GModDllPath;
                chkGMod.Checked = _profile.Gw1GModEnabled;

                RefreshGw1GModPluginList();
            }
            else if (isGw2)
            {
                grpGw2RunAfter.Visible = true;
                grpGw2RunAfter.Enabled = true;

                chkGw2RunAfterEnabled.Checked = _profile.Gw2RunAfterEnabled;

                UpdateGw2RunAfterUiState();
                RefreshGw2RunAfterList();
            }

            UpdateGw1ModsUiState();
            _loadingProfile = false;
        }

        private void SaveToProfile()
        {
            // Delegate saving to autonomous tabs
            _generalTab?.SaveProfile(_profile);
            _loginTab?.SaveProfile(_profile);

            // Legacy save for mods
            if (_profile.GameType == GameType.GuildWars1)
            {
                _profile.Gw1ToolboxEnabled = chkToolbox.Checked;
                _profile.Gw1ToolboxDllPath = txtToolboxDll.Text.Trim();

                _profile.Gw1Py4GwEnabled = chkPy4Gw.Checked;
                _profile.Gw1Py4GwDllPath = txtPy4GwDll.Text.Trim();

                _profile.Gw1GModEnabled = chkGMod.Checked;
                _profile.Gw1GModDllPath = txtGModDll.Text.Trim();

                // Remember last-known good tool paths (silent; no UI)
                TryRememberLastToolPath(_profile.Gw1ToolboxDllPath, () => _cfg.LastToolboxPath, v => _cfg.LastToolboxPath = v);
                TryRememberLastToolPath(_profile.Gw1Py4GwDllPath, () => _cfg.LastPy4GWPath, v => _cfg.LastPy4GWPath = v);
                TryRememberLastToolPath(_profile.Gw1GModDllPath, () => _cfg.LastGModPath, v => _cfg.LastGModPath = v);
                
                _cfg.Save();
            }

            if (_profile.GameType == GameType.GuildWars2)
            {
                _profile.Gw2RunAfterEnabled = chkGw2RunAfterEnabled.Checked;
                // RunAfter list is updated live in the UI list, so it's already in _profile object
                
                _cfg.Save();
            }
        }

        // -----------------------------
        // UI state updates
        // -----------------------------
        
        // (Removed UpdateGw1LoginUiState, UpdateGw1AutoLoginUiState, UpdateGw2LoginUiState)
        
        private void UpdateGw2RunAfterUiState()
        {
            // Only meaningful on GW2 profiles, but safe to call always
            bool enabled = chkGw2RunAfterEnabled.Checked;

            _gw2RunAfterInteractive = enabled;

            // Keep theme background ALWAYS; just grey out text and block actions.
            lvGw2RunAfter.Enabled = true;
            lvGw2RunAfter.BackColor = ThemeService.Palette.InputBack;
            lvGw2RunAfter.ForeColor = enabled ? ThemeService.Palette.InputFore : ThemeService.Palette.DisabledFore;

            btnGw2AddProgram.Enabled = enabled;
            btnGw2RemoveProgram.Enabled = enabled && (lvGw2RunAfter.SelectedItems.Count > 0);

            if (!enabled && lvGw2RunAfter.SelectedItems.Count > 0)
                lvGw2RunAfter.SelectedItems.Clear();
        }

        private void UpdateGw1ModsUiState()
        {
            // Toolbox
            txtToolboxDll.Enabled = chkToolbox.Checked;
            btnBrowseToolboxDll.Enabled = chkToolbox.Checked;

            // Py4GW
            txtPy4GwDll.Enabled = chkPy4Gw.Checked;
            btnBrowsePy4GwDll.Enabled = chkPy4Gw.Checked;

            // gMod
            bool gmod = chkGMod.Checked;
            _gw1GmodPluginsInteractive = gmod;

            txtGModDll.Enabled = gmod;
            btnBrowseGModDll.Enabled = gmod;

            // gMod plugins:
            // Keep the dark background ALWAYS (do not disable the control),
            // just grey out the text and block actions.
            lvGw1GModPlugins.Enabled = true; // keep theme background
            lvGw1GModPlugins.BackColor = ThemeService.Palette.InputBack;
            lvGw1GModPlugins.ForeColor = gmod ? ThemeService.Palette.InputFore : ThemeService.Palette.DisabledFore;
            lblGw1GModPlugins.Enabled = gmod;

            btnGw1AddPlugin.Enabled = gmod;
            btnGw1RemovePlugin.Enabled = gmod && (lvGw1GModPlugins.SelectedItems.Count > 0);

            // If gMod is off, also clear any selection so it *feels* disabled.
            if (!gmod && lvGw1GModPlugins.SelectedItems.Count > 0)
                lvGw1GModPlugins.SelectedItems.Clear();
        }

        // -----------------------------
        // GW2 Run-After list
        // -----------------------------

        private readonly ContextMenuStrip _gw2RunAfterMenu = new();
        private readonly ToolStripMenuItem _miPassMumble = new("Pass MumbleLink name") { CheckOnClick = true };

        private void InitGw2RunAfterContextMenu()
        {
            _gw2RunAfterMenu.Items.Add(_miPassMumble);

            _gw2RunAfterMenu.Opening += (s, e) =>
            {
                var p = GetSelectedGw2RunAfterProgram();
                if (p == null)
                {
                    e.Cancel = true;
                    return;
                }

                _miPassMumble.Checked = p.PassMumbleLinkName;
            };

            _miPassMumble.Click += (s, e) =>
            {
                var p = GetSelectedGw2RunAfterProgram();
                if (p == null) return;

                p.PassMumbleLinkName = _miPassMumble.Checked;
                RefreshGw2RunAfterList(); // refresh badge + tooltip
            };
        }

        private RunAfterProgram? GetSelectedGw2RunAfterProgram()
        {
            if (lvGw2RunAfter.SelectedItems.Count == 0)
                return null;

            return lvGw2RunAfter.SelectedItems[0].Tag as RunAfterProgram;
        }

        private void lvGw2RunAfter_MouseUp(object? sender, MouseEventArgs e)
        {
            if (e.Button != MouseButtons.Right)
                return;

            var hit = lvGw2RunAfter.HitTest(e.Location);
            if (hit.Item == null)
                return;

            hit.Item.Selected = true;
            _gw2RunAfterMenu.Show(lvGw2RunAfter, e.Location);
        }

        private void RefreshGw2RunAfterList()
        {
            lvGw2RunAfter.Items.Clear();

            foreach (var p in _profile.Gw2RunAfterPrograms ?? new List<RunAfterProgram>())
            {
                var item = new ListViewItem("");     // Column 0: empty text (checkbox lives here)
                item.SubItems.Add(p.Name);           // Column 1: name (we will draw badge inside this cell)

                item.Checked = p.Enabled;
                item.Tag = p;

                // Put the path in the tooltip now that we hid the path column
                item.ToolTipText =
                    (p.PassMumbleLinkName
                        ? "M = This program receives the GW2 MumbleLink name.\nUsed to pair overlays (e.g. Blish HUD) with this GW2 instance."
                        : "This program launches normally.\nRight-click to enable MumbleLink pairing (M).")
                    + $"\n\nPath:\n{p.ExePath}";


                lvGw2RunAfter.Items.Add(item);
            }

            UpdateGw2RunAfterButtons();
        }

        private void UpdateGw2RunAfterButtons()
        {
            // Only meaningful on GW2 profiles, but safe to call always
            bool enabled = chkGw2RunAfterEnabled.Checked;
            btnGw2RemoveProgram.Enabled = enabled && (lvGw2RunAfter.SelectedItems.Count > 0);
        }

        private void lvGw2RunAfter_ItemChecked(object sender, ItemCheckedEventArgs e)
        {
            if (e.Item.Tag is RunAfterProgram p)
                p.Enabled = e.Item.Checked;
        }

        private void btnGw2AddProgram_Click(object sender, EventArgs e)
        {
            using var dlg = new OpenFileDialog
            {
                Title = "Select program to run after launching",
                Filter = "Executable Files (*.exe)|*.exe|All Files (*.*)|*.*"
            };

            if (dlg.ShowDialog(this) != DialogResult.OK)
                return;

            var exe = dlg.FileName;

            // Friendly name: file description if available, else file name
            string name;
            try
            {
                var vi = FileVersionInfo.GetVersionInfo(exe);
                name = string.IsNullOrWhiteSpace(vi.FileDescription)
                    ? Path.GetFileNameWithoutExtension(exe)
                    : vi.FileDescription.Trim();
            }
            catch
            {
                name = Path.GetFileNameWithoutExtension(exe);
            }

            _profile.Gw2RunAfterPrograms.Add(new RunAfterProgram
            {
                Name = name,
                ExePath = exe,
                Enabled = true,
                PassMumbleLinkName = ShouldDefaultPassMumble(exe)
            });

            RefreshGw2RunAfterList();
        }

        private void btnGw2RemoveProgram_Click(object sender, EventArgs e)
        {
            if (lvGw2RunAfter.SelectedItems.Count == 0)
                return;

            var item = lvGw2RunAfter.SelectedItems[0];
            if (item.Tag is RunAfterProgram p)
            {
                _profile.Gw2RunAfterPrograms.Remove(p);
                RefreshGw2RunAfterList();
            }
        }

        // -----------------------------
        // GW1 gMod plugins list
        // -----------------------------

        private void RefreshGw1GModPluginList()
        {
            lvGw1GModPlugins.Items.Clear();

            foreach (var path in _profile.Gw1GModPluginPaths ?? new List<string>())
            {
                // Display: filename without extension (your preference)
                string display = Path.GetFileNameWithoutExtension(path);

                var item = new ListViewItem(display)
                {
                    Tag = path
                };

                lvGw1GModPlugins.Items.Add(item);
            }

            UpdateGw1GModPluginButtons();
        }

        private void UpdateGw1GModPluginButtons()
        {
            bool gmod = chkGMod.Checked;
            btnGw1RemovePlugin.Enabled = gmod && (lvGw1GModPlugins.SelectedItems.Count > 0);
        }

        private void btnGw1AddPlugin_Click(object? sender, EventArgs e)
        {
            using var dlg = new OpenFileDialog
            {
                Title = "Select gMod plugin (.tpf)",
                Filter = "TPF files (*.tpf)|*.tpf|All files (*.*)|*.*"
            };

            if (dlg.ShowDialog(this) != DialogResult.OK)
                return;

            string path = dlg.FileName;

            // Ensure list exists
            _profile.Gw1GModPluginPaths ??= new List<string>();

            // Dedupe (case-insensitive, absolute path as stored value)
            if (!_profile.Gw1GModPluginPaths.Any(p => string.Equals(p, path, StringComparison.OrdinalIgnoreCase)))
                _profile.Gw1GModPluginPaths.Add(path);

            RefreshGw1GModPluginList();
        }

        private void btnGw1RemovePlugin_Click(object? sender, EventArgs e)
        {
            if (lvGw1GModPlugins.SelectedItems.Count == 0)
                return;

            var item = lvGw1GModPlugins.SelectedItems[0];
            if (item.Tag is string path)
            {
                _profile.Gw1GModPluginPaths.RemoveAll(p => string.Equals(p, path, StringComparison.OrdinalIgnoreCase));
                RefreshGw1GModPluginList();
            }
        }

        // -----------------------------
        // Validation
        // -----------------------------

        private bool ValidateGw1ModSettings()
        {
            // Only relevant to GW1 profiles
            if (_profile.GameType != GameType.GuildWars1)
                return true;

            // Simple required-field checks; later we can add File.Exists if we want
            if (chkToolbox.Checked && string.IsNullOrWhiteSpace(txtToolboxDll.Text))
            {
                MessageBox.Show(
                    this,
                    "Toolbox is enabled, but no DLL path is set.\n\n" +
                    "Please browse to GWToolboxdll.dll or uncheck Toolbox.",
                    "Missing DLL path",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning);

                return false;
            }

            if (chkPy4Gw.Checked && string.IsNullOrWhiteSpace(txtPy4GwDll.Text))
            {
                MessageBox.Show(
                    this,
                    "Py4GW is enabled, but no DLL path is set.\n\n" +
                    "Please browse to the Py4GW DLL or uncheck Py4GW.",
                    "Missing DLL path",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning);

                return false;
            }

            if (chkGMod.Checked && string.IsNullOrWhiteSpace(txtGModDll.Text))
            {
                MessageBox.Show(
                    this,
                    "gMod is enabled, but no DLL path is set.\n\n" +
                    "Please browse to gMod.dll or uncheck gMod.",
                    "Missing DLL path",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning);

                return false;
            }

            return true;
        }

        // -----------------------------
        // Buttons / DialogResult
        // -----------------------------

        private void btnOk_Click(object? sender, EventArgs e)
        {
            // Pre-validation is now split. 
            // We'll rely on SaveProfile logic being safe, but we should probably validate display name here or in UserControl.
            // But getting text from UserControl is hard if we don't expose it.
            
            // 1. Save tabs to profile object
            SaveToProfile();

            // 2. Validate
            if (string.IsNullOrEmpty(_profile.Name))
            {
                MessageBox.Show(
                    this,
                    "Please enter a display name.",
                    "Validation",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning);

                DialogResult = DialogResult.None;
                return;
            }

            if (!ValidateGw1ModSettings())
            {
                DialogResult = DialogResult.None;
                return;
            }

            // If GW1 + gMod enabled, prepare %AppData% copy + modlist.txt now (so launch can't fail later)
            if (_profile.GameType == GameType.GuildWars1 && _profile.Gw1GModEnabled)
            {
                try
                {
                    Gw1InjectionService.PreparePerProfileGModFolder(_profile);
                }
                catch (Exception ex)
                {
                    MessageBox.Show(
                        this,
                        $"gMod is enabled but setup failed:\n\n{ex.Message}",
                        "gMod setup failed",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Warning);

                    DialogResult = DialogResult.None; // keep the dialog open
                    return;
                }
            }

            DialogResult = DialogResult.OK;
            Close();
        }

        private void btnCancel_Click(object? sender, EventArgs e)
        {
            DialogResult = DialogResult.Cancel;
            Close();
        }


        private bool IsDuplicateGw1Executable(string selectedExePath)
        {
            if (_profile.GameType != GameType.GuildWars1)
                return false;

            string selectedFull = Path.GetFullPath(selectedExePath);

            var pm = new GWxLauncher.Services.ProfileManager();
            pm.Load();

            return pm.Profiles.Any(p =>
                p.Id != _profile.Id &&
                p.GameType == GameType.GuildWars1 &&
                !string.IsNullOrWhiteSpace(p.ExecutablePath) &&
                string.Equals(Path.GetFullPath(p.ExecutablePath), selectedFull, StringComparison.OrdinalIgnoreCase));
        }

        // -----------------------------
        // Browse helpers
        // -----------------------------
        private static bool ShouldDefaultPassMumble(string exePath)
        {
            string file = Path.GetFileName(exePath);

            return
                file.Contains("blish", StringComparison.OrdinalIgnoreCase) ||
                file.Contains("taco", StringComparison.OrdinalIgnoreCase);
        }

        private void BrowseDllInto(TextBox textBox)
        {
            var exe = _profile.ExecutablePath; // Access from profile now, not txtExecutablePath
            string? fallbackDir = null;

            try
            {
                if (!string.IsNullOrWhiteSpace(exe) && File.Exists(exe))
                {
                    var dir = Path.GetDirectoryName(exe);
                    if (!string.IsNullOrWhiteSpace(dir) && Directory.Exists(dir))
                        fallbackDir = dir;
                }

                fallbackDir ??= Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles);
            }
            catch
            {
                fallbackDir = Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles);
            }

            _ = FilePickerHelper.TryPickDll(this, textBox, "Select DLL", fallbackDir);
        }

        private void EnsureDllSelectedOrRevert(CheckBox toggle, TextBox pathBox, string displayName)
        {
            var current = (pathBox.Text ?? "").Trim();

            // If we already have a valid path, we're good.
            if (!string.IsNullOrWhiteSpace(current))
                return;

            // Prompt: user is trying to enable tool with no path.
            var msg =
                $"{displayName} is enabled, but no DLL path is set.\n\n" +
                "Select the DLL now?";

            var result = MessageBox.Show(
                this,
                msg,
                "Missing DLL path",
                MessageBoxButtons.OKCancel,
                MessageBoxIcon.Warning);

            if (result == DialogResult.OK)
            {
                BrowseDllInto(pathBox);
                current = (pathBox.Text ?? "").Trim();

                // If still empty (user cancelled picker), revert toggle.
                if (string.IsNullOrWhiteSpace(current))
                    toggle.Checked = false;
            }
            else
            {
                toggle.Checked = false;
            }
        }

        private void TryRememberLastToolPath(string path, Func<string> getCurrent, Action<string> setValue)
        {
            path = (path ?? "").Trim();
            if (string.IsNullOrWhiteSpace(path))
                return;

            try
            {
                if (!File.Exists(path))
                    return;

                var current = (getCurrent?.Invoke() ?? "").Trim();
                if (!string.IsNullOrWhiteSpace(current))
                    return;

                setValue?.Invoke(path);
            }
            catch
            {
                // best-effort only
            }
        }

        private void btnBrowseToolboxDll_Click(object? sender, EventArgs e) => BrowseDllInto(txtToolboxDll);
        private void btnBrowsePy4GwDll_Click(object? sender, EventArgs e) => BrowseDllInto(txtPy4GwDll);
        private void btnBrowseGModDll_Click(object? sender, EventArgs e) => BrowseDllInto(txtGModDll);

        private void lblGw2Warning_Click(object sender, EventArgs e)
        {

        }
    }
}





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































